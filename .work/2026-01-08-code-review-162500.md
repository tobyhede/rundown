# Code Review - 2026-01-08

## Status: BLOCKED

## BLOCKING (Must Fix Before Merge)

**Remaining `tsv` references in CLI source code:**
- Description: User-facing error messages still reference `tsv` command instead of `rd` or `rundown`. This will confuse users who see error messages mentioning a command that does not exist.
- Location: `/Users/tobyhede/psrc/rundown/packages/cli/src/commands/ls.ts:63`
- Action: Replace `'tsv run <name>'` with `'rd run <name>'` or `'rundown run <name>'`

**Remaining `tsv` references in CLI source code (run.ts):**
- Description: Error messages reference `tsv ls --all` command which does not exist in rundown.
- Location: `/Users/tobyhede/psrc/rundown/packages/cli/src/commands/run.ts:70` and `:185`
- Action: Replace `'tsv ls --all'` with `'rd ls --all'` or `'rundown ls --all'`

**Remaining `tsv` references in CLI source code (goto.ts):**
- Description: Error message references `tsv goto` command which does not exist.
- Location: `/Users/tobyhede/psrc/rundown/packages/cli/src/commands/goto.ts:69`
- Action: Replace `tsv goto` with `rd goto` or `rundown goto`

**Remaining `tsv` references in parser fixtures:**
- Description: 11 conformance test fixtures use `tsv echo` command which may fail at runtime if executed. The `rd echo` command should be used instead for consistency with the rundown CLI.
- Location: `/Users/tobyhede/psrc/rundown/packages/parser/fixtures/conformance/valid/*.runbook.md` (multiple files)
- Action: Replace `tsv echo` with `rd echo` in all parser fixtures

**Orphan gate test files with turboshovel references:**
- Description: Compiled test files for removed `gate` command remain in the codebase with turboshovel references. These files (`gate.test.js`, `gate.test.d.ts`, `gate.test.js.map`, `gate.test.d.ts.map`) should not exist since there is no corresponding `gate.test.ts` source file and the gate command was removed.
- Location: `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/commands/gate.test.*`
- Action: Delete the orphan gate test files: `gate.test.js`, `gate.test.d.ts`, `gate.test.js.map`, `gate.test.d.ts.map`

**TURBOSHOVEL_LOG reference in compiled test-utils.js:**
- Description: The compiled `test-utils.js` file still references `TURBOSHOVEL_LOG` environment variable. While the source `.ts` file is correct, the compiled `.js` file has stale references indicating the build is out of sync.
- Location: `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/helpers/test-utils.js:73`
- Action: Rebuild the CLI package (`npm run build -w packages/cli`) and verify the compiled files are updated. If the stale references persist, the source file may have been copied without rebuilding.

**Turboshovel references in compiled test-utils.js paths:**
- Description: The compiled `test-utils.js` file references `.claude/turboshovel/` paths and `turboshovel.json` config file instead of `.claude/rundown/` and `rundown.json`.
- Location: `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/helpers/test-utils.js` lines 99, 100, 116
- Action: The source `test-utils.ts` appears correct, but compiled JS has stale content. Rebuild or verify the test-utils.ts compilation.


## NON-BLOCKING (May Be Deferred)

**Prefix in temp directory name:**
- Description: The temp directory prefix in `createTestWorkspace()` uses `rd-test-` which is fine, but there are references in compiled JS to `tsv-test-`. This indicates build artifacts are out of sync.
- Location: `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/helpers/test-utils.js:54`
- Action: Ensure clean rebuild. The source uses correct `rd-test-` prefix.


## Checklist

**Security & Correctness:**
- [x] No security vulnerabilities (SQL injection, XSS, CSRF, exposed secrets)
- [x] No insecure dependencies or deprecated cryptographic functions
- [ ] No critical logic bugs (meets acceptance criteria) - BLOCKED: stale references will cause runtime confusion
- [x] No race conditions, deadlocks, or data races
- [x] No unhandled errors, rejected promises, or panics
- [x] No breaking API or schema changes without migration plan

**Testing:**
- [x] All tests passing (unit, integration, property-based where applicable)
- [x] New logic has corresponding tests
- [x] Tests cover edge cases and error conditions
- [x] Tests verify behavior (not implementation details)
- [x] Property-based tests for mathematical/algorithmic code with invariants
- [x] Tests are isolated (independent, don't rely on other tests)
- [x] Test names are clear and use structured arrange-act-assert patterns

**Architecture:**
- [x] Single Responsibility Principle (functions/files have one clear purpose)
- [x] No non-trivial duplication (logic that if changed in one place would need changing elsewhere)
- [x] Clean separation of concerns (business logic separate from data marshalling)
- [x] No leaky abstractions (internal details not exposed)
- [x] No over-engineering (YAGNI - implement only current requirements)
- [x] No tight coupling (excessive dependencies between modules)
- [x] Proper encapsulation (internal details not exposed across boundaries)
- [x] Modules can be understood and tested in isolation

**Error Handling:**
- [x] No swallowed exceptions or silent failures
- [x] Error messages provide sufficient context for debugging
- [x] Fail-fast on invariants where appropriate

**Code Quality:**
- [x] Simple, not clever (straightforward solutions over complex ones)
- [x] Clear, descriptive naming (variables, functions, classes)
- [x] Type safety maintained
- [x] Follows language idioms and project patterns consistently
- [ ] No magic numbers or hardcoded strings (use named constants) - old CLI name hardcoded in error messages
- [x] Consistent approaches when similar functionality exists elsewhere
- [x] Comments explain "why" not "what" (code should be self-documenting)
- [x] Rationale provided for non-obvious design decisions
- [x] Doc comments for public APIs

**Process:**
- [x] No obvious performance issues (N+1 queries, inefficient algorithms on hot paths)
- [x] ALL linter warnings addressed by fixing root cause (disable/allow/ignore ONLY when unavoidable)
- [ ] Requirements met exactly (no scope creep) - BLOCKED: extraction incomplete, stale references remain
- [x] No unnecessary reinvention (appropriate use of existing libraries/patterns)

## Next Steps

1. Address BLOCKING issues (if any)
2. Consider NON-BLOCKING suggestions
3. Ready to merge when status is APPROVED or APPROVED WITH SUGGESTIONS

---

## Additional Context

**Commits reviewed:**
- `6140379` feat(cli): extract CLI package from turboshovel
- `2799908` docs: extract documentation from turboshovel
- `9bc5f5f` feat: complete rundown extraction from turboshovel

**Verification commands run:**
```bash
grep -ri "turboshovel" packages/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" --include="*.md"
grep -ri "tsv" packages/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" --include="*.md"
grep -ri "@turboshovel" packages/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json"
grep -ri "TURBOSHOVEL" packages/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json"
npm test
```

**Files with remaining issues:**

Source files requiring updates:
- `/Users/tobyhede/psrc/rundown/packages/cli/src/commands/ls.ts`
- `/Users/tobyhede/psrc/rundown/packages/cli/src/commands/run.ts`
- `/Users/tobyhede/psrc/rundown/packages/cli/src/commands/goto.ts`
- `/Users/tobyhede/psrc/rundown/packages/parser/fixtures/conformance/valid/*.runbook.md` (11 files)

Orphan files to delete:
- `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/commands/gate.test.js`
- `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/commands/gate.test.d.ts`
- `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/commands/gate.test.js.map`
- `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/commands/gate.test.d.ts.map`
- `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/helpers/test-utils.d.ts` (has stale turboshovel reference in JSDoc)
- `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/helpers/test-utils.d.ts.map`
- `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/helpers/test-utils.js`
- `/Users/tobyhede/psrc/rundown/packages/cli/__tests__/helpers/test-utils.js.map`

**Summary:**
The extraction is mostly complete, but several `tsv` and `turboshovel` references remain in CLI source files, parser fixtures, and orphan compiled files. Tests pass because the gate tests are compiled JS files without corresponding TypeScript sources (not picked up by Jest), and the `tsv` references in error messages do not affect test execution. These issues must be fixed before merge to ensure users see correct CLI names in error messages and documentation.
