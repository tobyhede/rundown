---
import Layout from '../../layouts/Layout.astro';
import { promises as fs } from 'node:fs';
import { parse as parseYaml } from 'yaml';
import path from 'node:path';

// Read patterns from runbooks/patterns directory
const patternsDir = path.resolve('..', 'runbooks', 'patterns');

async function getFiles(dir: string): Promise<string[]> {
  const dirents = await fs.readdir(dir, { withFileTypes: true });
  const files = await Promise.all(dirents.map((dirent) => {
    const res = path.join(dir, dirent.name);
    return dirent.isDirectory() ? getFiles(res) : Promise.resolve([res]);
  }));
  return Array.prototype.concat(...files);
}

const allFiles = await getFiles(patternsDir);
const runbookFiles = allFiles.filter((f) => f.endsWith('.runbook.md'));

interface PatternMeta {
  slug: string;
  name: string;
  description: string;
  tags: string[];
}

const patterns: PatternMeta[] = [];

for (const filePath of runbookFiles) {
  const content = await fs.readFile(filePath, 'utf-8');
  const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
  const fileName = path.basename(filePath);

  if (frontmatterMatch) {
    try {
      const frontmatter = parseYaml(frontmatterMatch[1]);
      patterns.push({
        slug: fileName.replace('.runbook.md', ''),
        name: frontmatter.name || fileName,
        description: frontmatter.description || '',
        tags: frontmatter.tags || [],
      });
    } catch {
      // Skip files with invalid frontmatter
    }
  }
}

// Sort alphabetically by name
patterns.sort((a, b) => a.name.localeCompare(b.name));

// Group by first tag
const grouped = patterns.reduce(
  (acc, p) => {
    const group = p.tags[0] || 'other';
    if (!acc[group]) acc[group] = [];
    acc[group].push(p);
    return acc;
  },
  {} as Record<string, PatternMeta[]>
);
---

<Layout title="Runbook Patterns | Rundown">
  <main class="container mx-auto px-4 py-16 max-w-6xl">
    <h1 class="text-4xl font-bold text-cyber-cyan mb-4">Runbook Patterns</h1>
    <p class="text-gray-400 mb-12 max-w-2xl">
      Interactive examples demonstrating Rundown's runbook patterns. Click any
      pattern to try it live in your browser.
    </p>

    {
      Object.entries(grouped).map(([group, items]) => (
        <section class="mb-12">
          <h2 class="text-xl font-semibold text-cyber-magenta mb-4 capitalize">
            {group}
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {items.map((pattern) => (
              <a
                href={`/patterns/${pattern.slug}`}
                class="block p-4 bg-cyber-darker border border-cyber-cyan/20 rounded-lg hover:border-cyber-cyan/50 hover:shadow-neon-cyan/20 transition-all"
              >
                <h3 class="font-mono text-cyber-cyan mb-2">{pattern.name}</h3>
                <p class="text-sm text-gray-400 line-clamp-2">
                  {pattern.description}
                </p>
                <div class="mt-3 flex flex-wrap gap-1">
                  {pattern.tags.map((tag) => (
                    <span class="text-xs px-2 py-0.5 bg-cyber-purple/20 text-cyber-purple rounded">
                      {tag}
                    </span>
                  ))}
                </div>
              </a>
            ))}
          </div>
        </section>
      ))
    }
  </main>
</Layout>
